#!/bin/zsh

if [ ! $1  ]; then
  echo '
  #  #  #
 #       #
 #  ##   #
#    #    #
 #   #   #
 #  ###  #
  #     #
  '
  exit;
fi

if [ $1 = "install" ] || [ $1 = "i" ]; then
  if [ $2 ] && [ -d ${HOME}/$2 ]; then
    module_dir=${HOME}/$2
    if [ -r $module_dir/Brewfile ]; then
      brew bundle --file=$module_dir/Brewfile
    fi
    if [ -f $module_dir/install ]; then
      read REPLY\?"Do you want exec install sh? (y/n)"
      if [ $REPLY = 'y' ]; then
        zsh $module_dir/install
      fi
    fi
    if [ -e $module_dir/.zshrc ]; then
      if [ ! $(grep -w $2 ~/.list) ]; then
        echo $2 >> ~/.list
      fi
    fi
  fi
  exit;
fi

if [ $1 = "init" ]; then
  if [ ! -f ~/.list ]; then
    touch .list
  fi
  exit;
fi

if [ $1 = "save" ]; then
  if [ -f ~/.list ]; then
    brew bundle --file=- dump \
  | cat - ~/.inkaku/Brewfile \
      $(
        for path in $(tail -r ~/.list); do
          if [ -r "${HOME}/$path/Brewfile" ]; then
            echo "${HOME}/$path/Brewfile"
          fi
        done
      ) \
  | sort | uniq -u > ~/Brewfile
  fi
  exit;
fi
