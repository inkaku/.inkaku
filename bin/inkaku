#!/bin/zsh

if [ $1 = "install" ] || [ $1 = "i" ]; then
  if [ -d ${HOME}/.inkaku/$2 ]; then
    if [ -r ${HOME}/.inkaku/$2/Brewfile ]; then
      brew bundle --file=${HOME}/.inkaku/$2/Brewfile
    fi
    if [ -f ${HOME}/.inkaku/$2/install ]; then
      zsh ${HOME}/.inkaku/$2/install
    fi
    if [ -e ~/.inkaku/$2/.zshrc ]; then
      if [ ! $(grep -w $2 ~/.inkaku/${USER}/module.list) ]; then
        echo $2 >> ~/.inkaku/${USER}/module.list
      fi
    fi
  fi
fi

if [ $1 = "init" ]; then
  if [ ! -d ~/.inkaku/${USER} ]; then
    mkdir -p ~/.inkaku/${USER}
    echo "${USER}" > ~/.inkaku/${USER}/module.list
    touch ~/.inkaku/${USER}/.zshrc
  fi
fi

if [ $1 = "save" ]; then
  if [ -d ~/.inkaku/${USER} ]; then
    brew bundle --file=- dump \
  | cat - ~/.inkaku/Brewfile \
      $(
        for path in $(tail -r ~/.inkaku/${USER}/module.list); do
          if [ -r "${HOME}/.inkaku/$path/Brewfile" ]; then
            echo "${HOME}/.inkaku/$path/Brewfile"
          fi
        done
      ) \
  | sort | uniq -u > ~/.inkaku/${USER}/Brewfile
  fi
fi
